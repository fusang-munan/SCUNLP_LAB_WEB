# 模板与布局定制

本文档说明如何修改页面结构，包括模板覆盖机制、Partial编写、常用模板变量等。

## 模板覆盖机制

Hugo采用"就近优先"原则查找模板。项目中的模板会覆盖主题提供的默认模板。

### 模板查找顺序

以 `publication` section 的单页模板为例：

```
1. layouts/publication/single.html        ← 项目自定义（最优先）
2. layouts/_default/single.html           ← 项目默认
3. themes/xxx/layouts/publication/single.html ← 主题自定义
4. themes/xxx/layouts/_default/single.html    ← 主题默认（Hugo Blox）
```

**覆盖原则：** 只需在 `layouts/` 中创建同路径同名文件即可覆盖。

### 当前项目的自定义模板

```
layouts/
├── achievement/
│   ├── section.html      # 成果列表（年份分组）
│   └── single.html       # 成果详情
├── announcement/
│   ├── section.html      # 公告列表
│   └── single.html       # 公告详情
├── publication/
│   ├── section.html      # 论文列表（带过滤器）
│   └── single.html       # 论文详情
└── partials/
    ├── blocks/
    │   ├── contact.html  # 联系表单Block
    │   └── people.html   # 人员展示Block
    ├── page_header.html
    ├── page_metadata_authors.html
    ├── site_footer.html
    └── site_footer_license.html
```

## 模板类型说明

### baseof.html（基础模板）

页面骨架，定义HTML结构：

```html
<!DOCTYPE html>
<html>
<head>
  {{ partial "site_head.html" . }}
</head>
<body>
  {{ partial "navbar.html" . }}
  
  <main>
    {{ block "main" . }}{{ end }}
  </main>
  
  {{ partial "site_footer.html" . }}
</body>
</html>
```

其他模板通过 `define "main"` 填充内容区。

### section.html（列表模板）

用于渲染Section的列表页（如 `/publication/`）：

```html
{{ define "main" }}
  <h1>{{ .Title }}</h1>
  
  {{ range .Pages }}
    <article>
      <a href="{{ .Permalink }}">{{ .Title }}</a>
      <time>{{ .Date.Format "2006-01-02" }}</time>
    </article>
  {{ end }}
  
  {{ template "_internal/pagination.html" . }}
{{ end }}
```

**关键变量：**
- `.Pages` — 当前Section下的所有页面
- `.Data.Pages` — 同上（更明确的写法）
- `.Paginator.Pages` — 分页后的页面

### single.html（单页模板）

用于渲染单个内容页面：

```html
{{ define "main" }}
  <article>
    <h1>{{ .Title }}</h1>
    <time>{{ .Date.Format "2006-01-02" }}</time>
    
    {{ with .Params.authors }}
      <div class="authors">
        {{ range . }}{{ . }}{{ end }}
      </div>
    {{ end }}
    
    <div class="content">
      {{ .Content }}
    </div>
  </article>
{{ end }}
```

### Partial（模板片段）

可复用的模板片段，存放在 `layouts/partials/`：

**定义Partial：**
```html
<!-- layouts/partials/author-link.html -->
<a href="{{ .link }}" class="author">{{ .name }}</a>
```

**调用Partial：**
```html
{{ partial "author-link.html" (dict "name" "张三" "link" "/author/zhang-san/") }}
```

## 常用模板变量

### 页面变量

| 变量 | 说明 |
|------|------|
| `.Title` | 页面标题 |
| `.Content` | 渲染后的正文内容 |
| `.RawContent` | 原始Markdown内容 |
| `.Summary` | 摘要（自动截取或手动设置） |
| `.Date` | 发布日期 |
| `.Lastmod` | 最后修改日期 |
| `.Permalink` | 完整URL |
| `.RelPermalink` | 相对URL |
| `.Type` | 内容类型（Section名） |
| `.Kind` | 页面类型（page/section/home等） |
| `.Draft` | 是否为草稿 |

### Front Matter 参数

```html
<!-- 访问自定义参数 -->
{{ .Params.authors }}
{{ .Params.publication }}
{{ .Params.abstract }}

<!-- 带默认值 -->
{{ .Params.featured | default false }}

<!-- 检查是否存在 -->
{{ with .Params.url_pdf }}
  <a href="{{ . }}">PDF</a>
{{ end }}
```

### 站点变量

| 变量 | 说明 |
|------|------|
| `.Site.Title` | 站点标题 |
| `.Site.BaseURL` | 站点基础URL |
| `.Site.Language` | 当前语言 |
| `.Site.Params` | params.yaml中的配置 |
| `.Site.Menus` | 菜单配置 |
| `.Site.Pages` | 所有页面 |
| `.Site.RegularPages` | 所有常规页面（不含列表页） |

```html
{{ .Site.Params.appearance.theme_day }}
{{ .Site.Title }}
```

### 页面集合操作

```html
<!-- 获取某Section的所有页面 -->
{{ $publications := where .Site.RegularPages "Section" "publication" }}

<!-- 过滤 -->
{{ $featured := where .Site.RegularPages ".Params.featured" true }}

<!-- 排序 -->
{{ range sort .Pages "Date" "desc" }}
{{ range sort .Pages ".Params.weight" }}

<!-- 限制数量 -->
{{ range first 5 .Pages }}

<!-- 组合使用 -->
{{ range first 10 (where .Site.RegularPages "Section" "publication") }}
  {{ .Title }}
{{ end }}
```

## 实战：自定义模板

### 示例1：修改论文详情页

当前论文详情页模板 `layouts/publication/single.html`：

```html
{{ define "main" }}
<div class="pub article-container">
  
  <!-- 标题区 -->
  <div class="article-header">
    <h1 class="article-title">
      {{ with .Params.url_pdf }}
        <a href="{{ . }}" class="article-title-link" target="_blank">
          {{ $.Title }}
        </a>
      {{ else }}
        {{ .Title }}
      {{ end }}
    </h1>
    
    <!-- 作者列表 -->
    <div class="article-authors">
      {{ partial "page_metadata_authors.html" . }}
    </div>
    
    <!-- 发表信息 -->
    <div class="article-meta">
      {{ with .Params.publication }}
        <span class="article-publication">{{ . }}</span>
      {{ end }}
    </div>
  </div>
  
  <!-- 摘要 -->
  {{ with .Params.abstract }}
  <div class="pub-section">
    <h2 class="pub-section-title">摘要</h2>
    <p class="pub-abstract">{{ . }}</p>
  </div>
  {{ end }}
  
  <!-- 链接按钮 -->
  <div class="pub-links">
    {{ with .Params.url_pdf }}
      <a href="{{ . }}" class="pub-link">
        <i class="fas fa-file-pdf"></i> PDF
      </a>
    {{ end }}
    {{ with .Params.url_code }}
      <a href="{{ . }}" class="pub-link">
        <i class="fab fa-github"></i> Code
      </a>
    {{ end }}
  </div>
  
</div>
{{ end }}
```

### 示例2：年份分组列表

当前成果列表页 `layouts/achievement/section.html` 的核心逻辑：

```html
{{ define "main" }}
{{ partial "page_header.html" . }}

<div class="universal-wrapper">
  {{/* 1. 从publication字段提取年份，构建分组 */}}
  {{ $scratch := newScratch }}
  {{ range .Data.Pages }}
    {{ $year := "" }}
    {{ if .Params.publication }}
      {{ $pub := .Params.publication | string }}
      {{ $yearMatch := findRE `\b(19|20)\d{2}\b` $pub }}
      {{ if $yearMatch }}
        {{ $year = index $yearMatch 0 }}
      {{ end }}
    {{ end }}
    {{ if $year }}
      {{ $yearPages := $scratch.Get $year | default (slice) }}
      {{ $yearPages = $yearPages | append . }}
      {{ $scratch.Set $year $yearPages }}
    {{ end }}
  {{ end }}

  {{/* 2. 收集所有年份并排序 */}}
  {{ $years := slice }}
  {{ range .Data.Pages }}
    {{ $year := "" }}
    {{ if .Params.publication }}
      {{ $pub := .Params.publication | string }}
      {{ $yearMatch := findRE `\b(19|20)\d{2}\b` $pub }}
      {{ if $yearMatch }}
        {{ $year = index $yearMatch 0 }}
        {{ if not (in $years $year) }}
          {{ $years = $years | append $year }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $years = sort $years "value" "desc" }}

  {{/* 3. 按年份渲染 */}}
  {{ range $year := $years }}
    {{ $pages := $scratch.Get $year }}
    <div class="row">
      <div class="col-lg-2">
        <h3>{{ $year }}</h3>
      </div>
      <div class="col-lg-10">
        {{ range $pages }}
          {{ partial "functions/render_view" (dict "page" $ "item" . "view" "compact") }}
        {{ end }}
      </div>
    </div>
  {{ end }}
</div>
{{ end }}
```

### 示例3：自定义作者显示

`layouts/partials/page_metadata_authors.html`：

```html
{{ $authors := .Params.authors }}
{{ $site_authors := .Site.GetPage "section" "authors" }}

{{ range $index, $author := $authors }}
  {{/* 尝试匹配站点作者 */}}
  {{ $author_page := false }}
  {{ if $site_authors }}
    {{ range $site_authors.Pages }}
      {{ if in .Params.authors $author }}
        {{ $author_page = . }}
      {{ end }}
    {{ end }}
  {{ end }}
  
  {{/* 分隔符 */}}
  {{ if $index }}, {{ end }}
  
  {{/* 输出：有链接或纯文本 */}}
  {{ if $author_page }}
    <a href="{{ $author_page.Permalink }}">{{ $author }}</a>
  {{ else }}
    {{ $author }}
  {{ end }}
{{ end }}
```

## 覆盖Block模板

Hugo Blox的Block模板位于主题的 `layouts/partials/blocks/` 目录。要覆盖：

1. 找到要覆盖的Block文件名（如 `people.html`）
2. 在项目中创建 `layouts/partials/blocks/people.html`
3. 复制原模板内容，修改需要的部分

### 当前覆盖的Block

**people.html** — 人员卡片布局：
- 自定义卡片样式
- 显示研究兴趣
- 显示毕业去向（如有）

**contact.html** — 联系表单：
- 自定义表单字段
- 支持Netlify/Formspree

## 调试技巧

### 输出变量值

```html
<!-- 调试时查看变量内容 -->
<pre>{{ printf "%#v" .Params }}</pre>
<pre>{{ .Params | jsonify }}</pre>

<!-- 条件调试 -->
{{ if .Site.IsServer }}
  <div class="debug">当前Section: {{ .Section }}</div>
{{ end }}
```

### 查看可用变量

```html
<!-- 列出所有Front Matter参数 -->
{{ range $key, $value := .Params }}
  <p>{{ $key }}: {{ $value }}</p>
{{ end }}
```

### 模板继承调试

在模板开头添加注释：

```html
{{ define "main" }}
<!-- DEBUG: 使用 layouts/publication/single.html -->
...
{{ end }}
```

## 下一步

需要修改视觉样式？阅读 [05-样式与主题定制](./05-样式与主题定制.md)。
